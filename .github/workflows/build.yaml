name: CI Builds

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  run:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin' # See 'Supported distributions' for available options
          java-version: '17'

      - name: Maven Verify
        run: |
          ./mvnw --batch-mode --no-transfer-progress -B verify

      - name: E2E Tests
        run: |
          EXPECTED_RESULT="Hello world"
          URL="http://localhost:8080/hello"

          function run_test {
              MAVEN_MODULE=$1
              echo "Running test for maven module $MAVEN_MODULE..."
              
              ./mvnw --batch-mode --no-transfer-progress -B compile exec:java -Dexec.mainClass="info.jab.ms.Main" -pl "$MAVEN_MODULE" &
              sleep 10
              RESPONSE=$(curl -s "$URL")
              
              if [ "$RESPONSE" = "$EXPECTED_RESULT" ]; then
                  echo "OK"
              else
                  echo "KO"
              fi
              
              kill $(lsof -t -i:8080)
          }

          run_test "1-servlet"
          run_test "2-spring-framework"
          run_test "3-spring-boot"